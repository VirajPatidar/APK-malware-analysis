import os
from django.conf import settings
from androguard.misc import AnalyzeAPK
import json

apk_package = None
apk_perms = []
found_package = None
found_permissions = []
found_combination = []
permission_data = {}

def analyze(path):
    global apk_package
    global apk_perms
    global found_package
    global found_permissions
    global found_combination
    isMalware = False
    a, d, dx = AnalyzeAPK(path)
    package = os.path.join(settings.BASE_DIR, 'static', 'data', 'malware_packages.json')
    permissions = os.path.join(settings.BASE_DIR, 'static', 'data', 'malware_perms.json')

    #-----------------------------PACKAGES----------------------------------#

    def check_package():
        
        global found_package
        global apk_package

        with open(package) as f:
            package_data = json.load(f)

        mal_packages = package_data['packages']
        found_package = None
        apk_package = a.get_package()

        # found_package = "rfwv"
        
        for i in mal_packages:
            if apk_package == i:
                found_package = i
                return True

        return False

    #-----------------------------PERMISSIONS-------------------------------#

    def check_permissions():
        
        global found_permissions

        with open(permissions) as f:
            permission_data = json.load(f)

        mal_permissions = permission_data['malware_only']

        found_permissions = []
        # found_permissions.append("Test1")
        # found_permissions.append("Test2")

        for i in a.get_permissions():
            str1 = ""
            for ele in i:
                if (ele.isupper() or ele == '_'):  
                    str1 += ele

            for j in mal_permissions:
                if str1 == j:
                    found_permissions.append(i)
                    break

        if len(found_permissions) > 0:
            return True
        else:
            return False

    #-----------------------------COMBINATIONS----------------------------------#

    def check_combinations():
        
        global found_combination
        global apk_perms
        
        with open(permissions) as f:
            permission_data = json.load(f)

        found_combination = []
        apk_perms = []
        # found_combination = ["abcd","1234","malware"]

        for i in a.get_permissions():
            str1 = ""
            for ele in i:
                if (ele.isupper() or ele == '_'):  
                    str1 += ele

            apk_perms.append(str1)

        for j in permission_data['combinations']:
            if (set(j).issubset(set(apk_perms))):
                found_combination = j
                return True
        
        return False

    def permission_info():
        
        global found_combination
        global permission_data

        f = open('static\data\permissions.json', )
        obj = json.load(f)
        keys = obj.keys()
        permission_data.clear()

        for i in found_combination:
            for j in keys:
                str1 = ""
                for ele in j:
                    if (ele.isupper() or ele == '_'):  
                        str1 += ele
                
                if str1 == i:
                    permission_data[i] = obj[j]['description']


    if(check_package()):
        isMalware = True

    if(check_permissions()):
        isMalware = True

    if(check_combinations()):
        isMalware = True
        permission_info()

    if isMalware == False:
        found_package = apk_package
        found_permissions = apk_perms
        permission_data.clear()

    return isMalware, found_package, found_permissions, found_combination, permission_data